# /pim-helpdesk-system/.github/workflows/azure-deploy.yml

name: Deploy API to Azure App Service

on:
  push:
    branches:
      - main # Altere para o nome do seu branch principal, se for diferente

env:
  AZURE_WEBAPP_NAME: helpdesk-pim-api-prod # <-- Mude para o nome que você dará ao seu App Service no Azure
  AZURE_WEBAPP_PACKAGE_PATH: 'backend/HelpDesk.Api/publish' # Caminho onde o projeto será publicado
  DOTNET_VERSION: '8.0.x' # Versão do .NET que você está usando

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: Production

    steps:
    - uses: actions/checkout@v4

    # 1. Configurar o ambiente .NET
    - name: Set up .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    # 2. Restaurar dependências
    - name: Restore dependencies
      run: dotnet restore backend/HelpDesk.Api/HelpDesk.Api.csproj

    # 3. Construir o projeto
    - name: Build project
      run: dotnet build backend/HelpDesk.Api/HelpDesk.Api.csproj --configuration Release --no-restore

    # 4. Publicar (Gerar os arquivos de deployment)
    - name: Publish project
      run: dotnet publish backend/HelpDesk.Api/HelpDesk.Api.csproj -c Release -o ${{ env.AZURE_WEBAPP_PACKAGE_PATH }} --no-build

    # 5. Implantar no Azure App Service
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
        # O segredo AZURE_WEBAPP_PUBLISH_PROFILE será configurado no GitHub
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
